name: PR Governance & Workflow

on:
  pull_request:
    types: [opened, edited, reopened, synchronize, ready_for_review, converted_to_draft, assigned, unassigned, closed]

permissions:
  contents: read
  pull-requests: write # Required for commenting
  repository-projects: write
  issues: read

jobs:
  validate-pr:
    name: Validate PR Standards
    runs-on: ubuntu-latest
    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- STEP 1: Check Assignee ---
      - name: Check Assignee
        id: check_assignee
        run: |
          ASSIGNEES=$(gh pr view ${{ github.event.pull_request.number }} --json assignees --jq '.assignees | length')
          if [ "$ASSIGNEES" -eq 0 ]; then
            echo "::error::‚õî Missing Assignee: You must assign this PR to a user."
            exit 1
          else
            echo "‚úÖ Assignee check passed."
          fi

      # --- STEP 2: Check Conventional Commits ---
      - name: Check Title Format (Conventional Commits)
        id: check_title
        run: |
          TITLE="${{ github.event.pull_request.title }}"
          # Regex: type(scope)?: description
          if [[ ! "$TITLE" =~ ^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?:[[:space:]].+ ]]; then
            echo "::error::‚õî Invalid Title: Must follow Conventional Commits (e.g., 'feat: Add new button')."
            exit 1
          else
            echo "‚úÖ Title format passed."
          fi

      # --- STEP 3: Validate Linked Issue in Title ---
      - name: Check Linked Issue & Title Match
        id: check_issue
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          TITLE="${{ github.event.pull_request.title }}"
          
          # Get Linked Issues (e.g., #50)
          # We use 'closingIssuesReferences' which catches "closes #50" or linked via sidebar
          ISSUE_JSON=$(gh pr view $PR_NUMBER --json closingIssuesReferences --jq '.closingIssuesReferences')
          ISSUE_COUNT=$(echo "$ISSUE_JSON" | jq 'length')

          if [ "$ISSUE_COUNT" -gt 0 ]; then
            # Extract the first issue number
            ISSUE_NUM=$(echo "$ISSUE_JSON" | jq -r '.[0].number')
            echo "üîó Found Linked Issue: #$ISSUE_NUM"

            # STRICT CHECK: The Issue Number MUST be in the Title
            if [[ "$TITLE" != *"$ISSUE_NUM"* ]]; then
              echo "::error::‚õî Title Mismatch: This PR is linked to Issue #$ISSUE_NUM, but the number is missing from the title."
              exit 1
            else
              echo "‚úÖ Title contains the linked issue number."
            fi

          else
            # NO ISSUE FOUND -> Post Warning (Do not fail)
            echo "‚ö†Ô∏è No linked issue found."
          
            WARNING_MSG="### ‚ö†Ô∏è PR Governance Notice<br/>No linked issue found. This PR will not be moved on the project board automatically."
          
            # Check if we already commented to avoid spam
            EXISTING_COMMENT=$(gh pr view $PR_NUMBER --json comments --jq ".comments[] | select(.body | contains(\"PR Governance Notice\")) | .id")
          
            if [ -z "$EXISTING_COMMENT" ]; then
              gh pr comment $PR_NUMBER --body "$WARNING_MSG"
              echo "‚úÖ Warning comment posted."
            else
              echo "‚ÑπÔ∏è Warning comment already exists."
            fi
          fi

  update-project-status:
    name: Update Project Status
    runs-on: ubuntu-latest
    needs: validate-pr
    if: success()
    env:
      GH_TOKEN: ${{ github.token }}
      ORGANIZATION: "puzzle"
      PROJECT_NUMBER: 17
      FIELD_NAME: "Status"
    steps:
      - name: Determine Target Status
        id: set_status
        run: |
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            echo "STATUS=üó≥Ô∏è Ready for Sprint Review" >> $GITHUB_ENV
          elif [ "${{ github.event.action }}" == "closed" ]; then
            echo "PR closed without merge. Skipping update."
            echo "STATUS=STOP" >> $GITHUB_ENV
          elif [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            echo "STATUS=In Implementation" >> $GITHUB_ENV
          else
            echo "STATUS=In review" >> $GITHUB_ENV
          fi

      - name: Find Linked Issue URL
        id: find_issue
        if: env.STATUS != 'STOP'
        run: |
          # Fetch linked issue URL
          LINKED_URL=$(gh pr view ${{ github.event.pull_request.number }} -R ${{ github.repository }} --json closingIssuesReferences --jq '.closingIssuesReferences[0].url')
          
          if [ -n "$LINKED_URL" ] && [ "$LINKED_URL" != "null" ]; then
            echo "TARGET_URL=$LINKED_URL" >> $GITHUB_ENV
            echo "‚úÖ Found Linked Issue: $LINKED_URL"
          else
            echo "‚ö†Ô∏è No linked issue found to move."
            echo "TARGET_URL=" >> $GITHUB_ENV
          fi

      - name: Move Item on Project Board
        if: env.STATUS != 'STOP' && env.TARGET_URL != ''
        run: |
          # 1. Add Item (Idempotent - returns ID if exists)
          ITEM_ID=$(gh project item-add "$PROJECT_NUMBER" --owner "$ORGANIZATION" --url "$TARGET_URL" --format json | jq -r '.id')
          
          # 2. Update Status
          if [ -n "$ITEM_ID" ]; then
            gh project item-edit --id "$ITEM_ID" --field-id "$FIELD_NAME" --project-id "$PROJECT_NUMBER" --text "$STATUS"
            echo "‚úÖ Moved Item to: $STATUS"
          else
            echo "‚ùå Failed to get Item ID."
            exit 1
          fi

      - name: Warn if Update Skipped
        if: env.STATUS != 'STOP' && env.TARGET_URL == ''
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # Switch back to standard token for commenting
        run: |
          echo "‚ö†Ô∏è Skipping Project Update because no linked issue was found."
          # We don't exit 1 here, we just finish successfully without moving anything.