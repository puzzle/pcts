name: PR Governance & Workflow

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review
      - converted_to_draft
      - assigned
      - unassigned
      - closed # üü¢ Added to detect merge events

permissions:
  contents: read
  pull-requests: write
  repository-projects: write

jobs:
  validate-pr:
    name: Validate PR Standards
    runs-on: ubuntu-latest
    steps:
      - name: Validate Title, Assignee, and Ticket
        uses: actions/github-script@v6
        with:
          script: |
            const pr = context.payload.pull_request;
            const title = pr.title;
            
            let blockingErrors = [];
            let warnings = [];

            // --- 1. BLOCKING CHECK: Assignee ---
            if (pr.assignees.length === 0) {
              blockingErrors.push('‚õî **Missing Assignee**: You must assign this PR to a user.');
            }

            // --- 2. BLOCKING CHECK: Conventional Commits ---
            const conventionalRegex = /^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\([a-z0-9-]+\))?:\s.+$/;

            if (!conventionalRegex.test(title)) {
              blockingErrors.push(
                '‚õî **Invalid Title**: Must follow Conventional Commits.\n' +
                'Example: `feat: Allow users to upload photos`'
              );
            }

            // --- 3. WARNING CHECK: Ticket Number (Optional) ---
            const ticketRegex = /\s#\d+$/;
            
            if (!ticketRegex.test(title)) {
              warnings.push('‚ö†Ô∏è **Notice**: No ticket number found at the end of the title. (Optional)');
            }

            // --- 4. Handle Warnings (Post Comment) ---
            // We skip posting comments on Merged/Closed PRs to avoid noise
            if (warnings.length > 0 && context.payload.action !== 'closed') {
              console.log("Warnings found. Processing comment...");
            
              const commentHeader = "### ‚ö†Ô∏è PR Governance Notices";
              const commentBody = `${commentHeader}\n\n${warnings.join('\n\n')}`;
            
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
              });
            
              const botComment = comments.data.find(c => c.body.includes(commentHeader));

              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: commentBody
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: commentBody
                });
              }
            }

            // --- 5. Handle Failures ---
            if (blockingErrors.length > 0) {
              core.setFailed(blockingErrors.join('\n'));
            } else {
              console.log("‚úÖ Blocking requirements passed.");
            }

  update-project-status:
    name: Update Project Status
    runs-on: ubuntu-latest
    needs: validate-pr
    if: success()
    env:
      GH_TOKEN: ${{ github.token }}
      ORGANIZATION: "puzzle"
      PROJECT_NUMBER: 17
      FIELD_NAME: "Status"
    steps:
      - name: Update Project Item Status
        run: |
          # 1. Determine Desired Status
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            # üü¢ PR was Merged
            STATUS="üó≥Ô∏è Ready for Sprint Review"
          elif [ "${{ github.event.action }}" == "closed" ]; then
            # üî¥ PR was Closed but NOT Merged (e.g. cancelled)
            echo "PR was closed without merging. No status update required."
            exit 0
          elif [ "${{ github.event.pull_request.draft }}" == "true" ]; then
            # ‚ö™ PR is a Draft
            STATUS="In Implementation"
          else
            # üîµ PR is Open and Ready
            STATUS="In review"
          fi
          
          echo "Processing PR #${{ github.event.pull_request.number }}..."
          echo "Target Status: $STATUS"

          # 2. Add PR to Project (if not already there) and Get Item ID
          ITEM_ID=$(gh project item-add "$PROJECT_NUMBER" --owner "$ORGANIZATION" --url "${{ github.event.pull_request.html_url }}" --format json | jq -r '.id')
          
          # 3. Move Item to Status Column
          gh project item-edit --id "$ITEM_ID" --field-id "$FIELD_NAME" --project-id "$PROJECT_NUMBER" --text "$STATUS"